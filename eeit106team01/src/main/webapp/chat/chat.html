<!DOCTYPE html>
<html lang="en">

<head>
	<title>Index</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
	<link rel="stylesheet" href="assets/js/jquery-ui/css/no-theme/jquery-ui-1.10.3.custom.min.css">
	<link rel="stylesheet" href="assets/css/font-icons/entypo/css/entypo.css">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans:400,700,400italic">
	<link rel="stylesheet" href="assets/css/neon-core.css">
	<link rel="stylesheet" href="assets/css/neon-theme.css">
	<link rel="stylesheet" href="assets/css/neon-forms.css">
	<link rel="stylesheet" href="assets/css/custom.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
	<script src="/chat/js/sockjs.min.js"></script>
	<script src="/chat/js/stomp.min.js"></script>

	<script>

		function onSubmitMessage(id, msg, chatData) {
			console.log(id);
			console.log(msg);
			console.log(chatData);

			if (id === "north") {
				stompClient.send("/north", {}, JSON.stringify({ 'name': name, 'message': msg }));

			} else {
				stompClient.send("/msg", {}, JSON.stringify({ 'toUser': id, 'fromUser': name, 'message': msg }));
			}


		}

		function onReceiveMessage(id, msgBean) {
			if (msgBean && msgBean.name !== name) {
				neonChat.pushMessage(id, msgBean.message, msgBean.name, new Date(msgBean.sendTime), true, true);
				neonChat.renderMessages(id);
			}
		}

		function onReceivePrivateMessage(id, msgBean) {
			if (msgBean && msgBean.name !== name) {
				neonChat.pushMessage(id, msgBean.message, msgBean.fromUser, new Date(msgBean.sendTime), true, true);
				neonChat.renderMessages(id);
			}
		}

		function showOldMessage(id, msgBeans) {
			let fromOpponent;
			for (let i = 0; i < msgBeans.length; i++) {
				if (msgBeans[i].name !== name) {
					fromOpponent = true;
				} else {
					fromOpponent = false;
				}
				neonChat.pushMessage(id, msgBeans[i].message, msgBeans[i].name, new Date(msgBeans[i].sendTime), fromOpponent, false);
			}
			neonChat.renderMessages(id);
		}

		function showOldPrivateMessage(msgBeans) {
			let fromOpponent;
			for (let i = 0; i < msgBeans.length; i++) {
				let id;
				if (msgBeans[i].userOne !== name) {
					id = msgBeans[i].userOne;
				} else {
					id = msgBeans[i].userTwo;
				}
				for (let j = 0; j < msgBeans[i].messages.length; j++) {
					if (msgBeans[i].messages[j].fromUser !== name) {
						fromOpponent = true;
					} else {
						fromOpponent = false;
					}
					neonChat.pushMessage(id, msgBeans[i].messages[j].message, msgBeans[i].messages[j].fromUser, new Date(msgBeans[i].messages[j].sendTime), fromOpponent, false);
				}
				for (let j = 0; j < msgBeans[i].userOneOfflineMessages.length; j++) {
					if (msgBeans[i].userOneOfflineMessages[j].fromUser !== name) {
						fromOpponent = true;
					} else {
						fromOpponent = false;
					}
					neonChat.pushMessage(id, msgBeans[i].userOneOfflineMessages[j].message, msgBeans[i].userOneOfflineMessages[j].fromUser, new Date(msgBeans[i].userOneOfflineMessages[j].sendTime), fromOpponent, fromOpponent);
				}
				for (let j = 0; j < msgBeans[i].userTwoOfflineMessages.length; j++) {
					if (msgBeans[i].userTwoOfflineMessages[j].fromUser !== name) {
						fromOpponent = true;
					} else {
						fromOpponent = false;
					}
					neonChat.pushMessage(id, msgBeans[i].userTwoOfflineMessages[j].message, msgBeans[i].userTwoOfflineMessages[j].fromUser, new Date(msgBeans[i].userTwoOfflineMessages[j].sendTime), fromOpponent, fromOpponent);
				}
				neonChat.renderMessages(id);
			}
		}

		var stompClient = null;

		function setConnected(connected) {
			document.getElementById("connect").disabled = connected;
			document.getElementById("disconnect").disabled = !connected;
			document.getElementById("conversationDiv").style.visibility = connected ? 'visible' : 'hidden';
			$("#response").html();
			$("#callback").html();
		}

		var name;

		function connect() {
			name = $('#name').val();
			var socket = new SockJS('/simple');
			stompClient = Stomp.over(socket);
			stompClient.connect({
				'name': name
			}, function (frame) {
				setConnected(true);
				console.log('Connected:' + frame);

			});
			$('#chat').attr('data-current-user', name);
		}

		function disconnect() {
			if (stompClient != null) {
				stompClient.disconnect();
			}
			setConnected(false);
			console.log('Disconnected');
		}

		function sendName() {
			stompClient.subscribe('/user/topic/msg', function (response) {
				var msgBean = JSON.parse(response.body);
				console.log(msgBean);
				if (Array.isArray(msgBean)) {
					showOldPrivateMessage(msgBean);
				} else {
					onReceivePrivateMessage(msgBean.fromUser, msgBean);
				}
			});
		}


		document.addEventListener("DOMContentLoaded", function () {
			$("#north").click(function () {
				if (stompClient != null) {
					stompClient.subscribe('/topic/north', function (response) {
						var msgBean = JSON.parse(response.body);
						console.log(msgBean);
						if (Array.isArray(msgBean)) {
							showOldMessage("north", msgBean);
						} else {
							onReceiveMessage("north", msgBean);
						}
					});
				}
				neonChat.setStatus($(this).attr("id"), "online");
				$(this).unbind();
			});
		});
	</script>

</head>

<body>

	<div class="jumbotron text-center" style="margin-bottom: 0">
		<h1>Index Page</h1>
		<p>Resize this responsive page to see the effect!</p>

	</div>
	<nav class="navbar navbar-expand-sm bg-dark navbar-dark">
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#collapsibleNavbar">
			<span class="navbar-toggler-icon"></span>
		</button>
		<div class="collapse navbar-collapse" id="collapsibleNavbar">
			<ul class="navbar-nav">
				<li class="nav-item active"><a class="nav-link" href="index.html">Index</a></li>
				<li class="nav-item"><a class="nav-link" href="video.html">Video</a></li>
				<li class="nav-item"><a class="nav-link" href="upload.html">Upload</a></li>
			</ul>
		</div>
	</nav>

	<div class="container" style="margin-top: 2%">
		<div class="row">
			<div class="col-sm-4">
			</div>
			<div class="col-sm-4">
				<h3>Column 2</h3>
				<div>
					<button id="connect" onclick="connect();">Connect</button>
					<button id="disconnect" disabled="disabled" onclick="disconnect();">Disconnect</button>
				</div>

				<div id="conversationDiv">
					<label>Input your name: <input type="text" id="name" /></label>
					<button id="sendName" onclick="sendName();">Send</button>
					<p id="response"></p>
					<p id="callback"></p>
				</div>
			</div>
			<div class="col-sm-4">
				<h3>Column 3</h3>
			</div>
		</div>
	</div>
	<div class="page-container">

		<a href="#" class="btn btn-default" data-toggle="chat" style="float: right">Toggle Chat</a>
		<a href="#" class="btn btn-default chat-open">Force Open</a>
		<span class="badge badge-danger chat-notifications-badge is-hidden" style="float: right"></span>
		<div id="chat" class="fixed" data-current-user="測試用一號" data-order-by-status="1" data-max-chat-history="25">

			<div class="chat-inner">


				<h2 class="chat-header">
					<a href="#" class="chat-close"><i class="entypo-cancel"></i></a>

					<i class="entypo-users"></i>
					Chat
					<span class="badge badge-success is-hidden">0</span>
				</h2>

				<div class="chat-group" id="group-1">
					<strong>區域</strong>


					<a href="#" id="north"><span class="user-status is-offline"></span> <em>北部聊天室</em></a>
					<a href="#" id="midChat"><span class="user-status is-offline"></span> <em>中部聊天室</em></a>
					<a href="#" id="southChat"><span class="user-status is-offline"></span> <em>南部聊天室</em></a>
					<a href="#" id="eastChat"><span class="user-status is-offline"></span> <em>東部聊天室</em></a>
				</div>


				<div class="chat-group" id="group-2">
					<strong>Favorites</strong>

					<a href="#" id="pikachu"><span class="user-status is-offline"></span> <em>pikachu</em></a>
					<a href="#" id="sonic"><span class="user-status is-offline"></span> <em>sonic</em></a>
				</div>

			</div>

			<!-- conversation template -->
			<div class="chat-conversation">

				<div class="conversation-header">
					<a href="#" class="conversation-close"><i class="entypo-cancel"></i></a>

					<span class="user-status"></span>
					<span class="display-name"></span>
					<small></small>
				</div>

				<ul class="conversation-body">
				</ul>

				<div class="chat-textarea">
					<textarea class="form-control autogrow" placeholder="Type your message"></textarea>
				</div>

			</div>

		</div>
		<!-- Chat Histories -->
		<div class="chat-history" id="sample_history">
			<li>
				<span class="user">Art Ramadani</span>
				<p>Are you here?</p>
				<span class="time">09:00</span>
			</li>

			<li class="opponent">
				<span class="user">Catherine J. Watkins</span>
				<p>This message is pre-queued.</p>
				<span class="time">09:25</span>
			</li>

			<li class="opponent">
				<span class="user">Catherine J. Watkins</span>
				<p>Whohoo!</p>
				<span class="time">09:26</span>
			</li>

			<li class="opponent unread">
				<span class="user">Catherine J. Watkins</span>
				<p>Do you like it?</p>
				<span class="time">09:27</span>
			</li>
		</div>


		<!-- Chat Histories -->
		<div class="chat-history" id="sample_history_2">
			<li class="opponent unread">
				<span class="user">Daniel A. Pena</span>
				<p>I am going out.</p>
				<span class="time">08:21</span>
			</li>

			<li class="opponent unread">
				<span class="user">Daniel A. Pena</span>
				<p>Call me when you see this message.</p>
				<span class="time">08:27</span>
			</li>
		</div>
	</div>
	<!-- Bottom scripts (common) -->
	<script src="assets/js/gsap/TweenMax.min.js"></script>
	<!-- <script src="assets/js/jquery-ui/js/jquery-ui-1.10.3.minimal.min.js"></script> -->
	<!-- <script src="assets/js/bootstrap.js"></script> -->
	<script src="assets/js/joinable.js"></script>
	<script src="assets/js/resizeable.js"></script>
	<script src="assets/js/neon-api.js"></script>


	<!-- Imported scripts on this page -->
	<script src="assets/js/neon-chat.js"></script>


	<!-- JavaScripts initializations and stuff -->
	<script src="assets/js/neon-custom.js"></script>
	<!-- Demo Settings -->
	<script src="assets/js/neon-demo.js"></script>
</body>


</html>