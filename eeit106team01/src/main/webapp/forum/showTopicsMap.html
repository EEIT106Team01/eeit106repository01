<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>探索</title>
    <link rel="stylesheet"
        href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <script
        src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script
        src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <!-- <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ="
        crossorigin="anonymous"></script> -->
    <!-- google map -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAiREDDjOZrkP5eWTeVhK3xF7uVZr6MGp0" async defer></script>
    <!-- Main Quill library -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
	<script src="/forum/quill/quill.js"></script>
    <script src="/forum/quill/quill.min.js"></script>
    <!-- plyr -->
    <link rel="stylesheet" href="https://cdn.plyr.io/3.5.3/plyr.css" />
    <script src="https://cdn.plyr.io/3.5.3/plyr.polyfilled.js"></script>
    
    <script src="js/topic/createTopicView.js"></script>
    
    <script type="text/javascript">
        $(window).on('load', initMap);
        let map;
        let markers = [];
        let listener;

        function initMap() {
            map = new google.maps.Map(document.getElementById("map_canvas"), {
                    zoom: 13    //0-21
                    , center: { lat: 25.033793, lng: 121.543427 }
                    , scaleControl: true
                    // , maxZoom: 15
                    // , minZoom: 8
                });
            
            google.maps.event.addListener(map, 'dragstart', onDragstart);
            google.maps.event.addListener(map, 'dragend', onDragend);
            listener = google.maps.event.addListener(map, 'bounds_changed', onBounds_changed);
        }

        function getTopicList() {
            let lowerLatitude = map.getBounds().getSouthWest().lat();   //南緯
            let upperLatitude = map.getBounds().getNorthEast().lat();   //北緯
            let lowerLongitude = map.getBounds().getSouthWest().lng();  //西經
            let upperLongitude = map.getBounds().getNorthEast().lng();  //東經
            $.ajax({
                url: `http://localhost:8080/articleTopics?lowerLatitude=${lowerLatitude}&upperLatitude=${upperLatitude}&lowerLongitude=${lowerLongitude}&upperLongitude=${upperLongitude}`,
                type: "GET",
                success: function (dataTopicList) {
                    createTopicView(dataTopicList, "topicList");
                    addMarker(dataTopicList);
                }
            })
        }

        function addMarker(dataTopicList) {
            for (let i = 0; i < markers.length; i++){
                markers[i].setMap(null);
            }

            for (let i = 0; i < dataTopicList.length; i++) {
                markers[i] = 
                    new google.maps.Marker({
                        position: {
                            lat: dataTopicList[i].accidentLocationLatitude,
                            lng: dataTopicList[i].accidentLocationLongitude
                        }
                        , map: map
                        , label: `${dataTopicList[i].id}`
                        // , animation: google.maps.Animation.BOUNCE    //for marker remove check
                    });

                markers[i].addListener('mouseover', function() {
                    $(`#id${dataTopicList[i].id}`).addClass("bg-info");
                });

                markers[i].addListener('mouseout', function() {
                    $(`#id${dataTopicList[i].id}`).removeClass("bg-info");
                });
            }
        }

        function onDragstart() {
            google.maps.event.removeListener(listener);
        }

        function onDragend() {
            listener = google.maps.event.addListener(map, 'bounds_changed', onBounds_changed);
        }

        function onBounds_changed() {
            getTopicList();
        }


    </script>


</head>

<body>
    <div id="map_canvas" style="width:600px; height:500px; float: right;"></div>
    <hr>
    <div id="topicList"></div>
</body>

</html>